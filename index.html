<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>數獨遊戲</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    .controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
    .controls button, .controls select { font-size: 14px; padding: 5px 10px; }
    .sudoku-board { display: grid; grid-template-columns: repeat(9, 40px); grid-gap: 1px; justify-content: center; }
    .cell {
      width: 40px; height: 40px; line-height: 40px;
      text-align: center; font-size: 18px; border: 1px solid #ccc;
      position: relative; user-select: none;
    }
    .cell.readonly { background-color: #eee; }
    .cell.highlight { background-color: #d0f0ff; }
    .cell.invalid { background-color: #ffcccc; }
    .cell.valid { background-color: #ccffcc; }
    .cell.hint { background-color: #ccffcc; }  /* 綠色背景提示 */
    .cell:nth-child(3n) { border-right: 2px solid #000; }
    .cell:nth-child(n+19):nth-child(-n+27),
    .cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid #000; }
    .cell:nth-child(1), .cell:nth-child(4), .cell:nth-child(7),
    .cell:nth-child(28), .cell:nth-child(31), .cell:nth-child(34),
    .cell:nth-child(55), .cell:nth-child(58), .cell:nth-child(61) { border-left: 2px solid #000; }
    .cell:nth-child(n+1):nth-child(-n+9) { border-top: 2px solid #000; }
    .notes {
      display: grid; grid-template-columns: repeat(3, 1fr);
      font-size: 10px; line-height: 12px; width:100%; height:100%;
      position: absolute; top:0; left:0;
    }
    .notes span { display: flex; align-items: center; justify-content: center; }
    .input-panel-mobile { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 10px; gap: 5px; }
    .input-panel-mobile button { width: 40px; height: 40px; font-size: 16px; }
  </style>
</head>
<body>
  <div id="app">
    <div class="controls">
      <label>難度： 
        <select v-model="difficulty" @change="startGame">
          <option value="easy">簡單</option>
          <option value="medium">中等</option>
          <option value="hard">困難</option>
        </select>
      </label>
      <button @click="startGame">開始新遊戲</button>
      <button @click="toggleNoteMode">筆記模式：{{ noteMode ? '開' : '關' }}</button>
      <button @click="giveHint">提示</button>
    </div>
    <div class="sudoku-board">
      <div v-for="(cell, i) in board" :key="i" class="cell"
           :class="[{ readonly: cell.readonly }, { highlight: selectedIndex===i && cell.value }, { invalid: selectedIndex===i && !isValidCell(i) }, { valid: selectedIndex===i && cell.value && isValidCell(i) }, { hint: cell.hint }]">
        <template v-if="cell.value">
          {{ cell.value }}
        </template>
        <template v-else-if="noteMode && cell.notes.length">
          <div class="notes">
            <span v-for="n in 9" :key="n">{{ cell.notes.includes(n) ? n : '' }}</span>
          </div>
        </template>
      </div>
    </div>
    <div v-if="isMobile && selectedIndex!==null" class="input-panel-mobile">
      <button v-for="n in 9" :key="n" @click="inputNumber(n)">{{ n }}</button>
      <button @click="inputNumber('')">清除</button>
      <button @click="undo">復原</button>
    </div>
  </div>
  <script src="https://unpkg.com/vue@3"></script>
  <script>
    const { createApp, onMounted, onBeforeUnmount } = Vue;
    createApp({
      data() {
        return {
          board: [], solution: [], noteMode: false,
          selectedIndex: null, difficulty: 'medium', isMobile: false,
          history: []
        };
      },
      mounted() {
        this.isMobile = /Mobi|Android/i.test(navigator.userAgent);
        this.startGame();
        window.addEventListener('keydown', this.handleKeydown);
      },
      beforeUnmount() {
        window.removeEventListener('keydown', this.handleKeydown);
      },
      methods: {
        startGame() {
          this.history = [];
          const full = this.generateFullSudoku();
          this.solution = full.map(r => r.slice());
          const puzzle = full.map(r => r.slice());
          const removeCount = this.difficulty==='easy'?30:this.difficulty==='medium'?40:50;
          let cnt=0;
          while(cnt<removeCount){ const r=Math.floor(Math.random()*9), c=Math.floor(Math.random()*9);
            if(puzzle[r][c]!==0){ puzzle[r][c]=0; cnt++; }
          }
          this.board = [];
          puzzle.flat().forEach((v, idx)=>{
            this.board.push({
              value: v? v.toString():'', readonly: v!==0,
              row:Math.floor(idx/9), col:idx%9, notes:[], hint: false });
          });
          this.selectedIndex = null;
        },
        generateFullSudoku() {
          const board=[...Array(9)].map(_=>Array(9).fill(0));
          const valid=(b,r,c,n)=>{ for(let i=0;i<9;i++){
            if(b[r][i]===n||b[i][c]===n) return false;
            const br=3*Math.floor(r/3)+Math.floor(i/3);
            const bc=3*Math.floor(c/3)+(i%3);
            if(b[br][bc]===n) return false;
          } return true;};
          const fill=(b)=>{ for(let r=0;r<9;r++) for(let c=0;c<9;c++) if(b[r][c]===0){
              const nums=[1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
              for(const n of nums){ if(valid(b,r,c,n)){ b[r][c]=n; if(fill(b)) return true; b[r][c]=0; }}
              return false;
          } return true;};
          fill(board);
          return board;
        },
        selectCell(i){ if(!this.board[i].readonly) this.selectedIndex=i; },
        inputNumber(n) {
          if (this.selectedIndex === null) return;
          const cell = this.board[this.selectedIndex];
          if (cell.readonly) return;

          this.history.push({ index: this.selectedIndex, prev: cell.value, prevNotes: [...cell.notes] });

          if (n === '') {
            cell.value = '';
            cell.notes = [];
          } else {
            if (this.noteMode) {
              const num = Number(n), notes = cell.notes;
              cell.notes = notes.includes(num) ? notes.filter(x => x !== num) : [...notes, num].sort();
            } else {
              cell.value = n;
              cell.notes = [];
            }
          }

          if (!this.isValidCell(this.selectedIndex)) {
            cell.invalid = true; 
          } else {
            cell.invalid = false; 
          }

          if (this.isMobile) {
            this.checkForDuplicateInRowColBlock(cell);
          }
        },
        checkForDuplicateInRowColBlock(cell) {
          const num = cell.value;
          if (!num) return;

          let count = 0;

          for (let i = 0; i < 9; i++) {
            if (this.board[cell.row * 9 + i].value === num) count++;
            if (this.board[i * 9 + cell.col].value === num) count++;
          }

          const br = 3 * Math.floor(cell.row / 3), bc = 3 * Math.floor(cell.col / 3);
          for (let r = br; r < br + 3; r++) {
            for (let c = bc; c < bc + 3; c++) {
              if (this.board[r * 9 + c].value === num) count++;
            }
          }

          if (count > 1) {
            this.board[cell.row * 9 + cell.col].invalid = true;
          } else {
            this.board[cell.row * 9 + cell.col].invalid = false;
          }
        },
        isValidCell(i) {
          const cell = this.board[i];
          return this.checkValid(cell, cell.row, cell.col, cell.value);
        },
        checkValid(cell, row, col, value) {
          if (!value) return true;
          for (let i = 0; i < 9; i++) {
            if ((i !== col && this.board[row * 9 + i].value === value) || 
                (i !== row && this.board[i * 9 + col].value === value)) return false;
          }

          const br = 3 * Math.floor(row / 3), bc = 3 * Math.floor(col / 3);
          for (let r = br; r < br + 3; r++) {
            for (let c = bc; c < bc + 3; c++) {
              if (this.board[r * 9 + c].value === value) return false;
            }
          }
          return true;
        },
        
        giveHint() {
  if (this.selectedIndex === null) return;
  const correctValue = this.solution[this.board[this.selectedIndex].row][this.board[this.selectedIndex].col];
  const selectedCell = this.board[this.selectedIndex];
          this.board[this.selectedIndex].value = correctValue;
          this.board[this.selectedIndex].hint = true;  // 設置為提示
       },
        undo() {
          if (this.history.length === 0) return;
          const lastState = this.history.pop();
          this.board[lastState.index].value = lastState.prev;
          this.board[lastState.index].notes = lastState.prevNotes;
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
